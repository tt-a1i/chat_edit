# 重构优先级执行清单

> **快速参考**: 按优先级排序的重构任务清单
> **完整报告**: 参见 `重构优化报告-更新版.md`

---

## 🎯 当前项目健康度: 72/100 (+12)

### 改进亮点
- ✅ 统一错误处理系统已完成
- ✅ Pinia 状态管理统一
- ✅ ESLint 规则优化（从 100+ 错误降至 65 警告）
- ✅ Git hooks 和自动格式化

---

## 📋 立即行动（本周）

### 🔴 P0: 内存泄漏修复（0.5人天）
**问题**: 15+ 个未清理的事件监听器
**影响**: 长时间使用导致内存累积

**任务**:
- [ ] 审计所有 `addEventListener` 调用
- [ ] 使用 VueUse 的 `useEventListener` 替换
- [ ] 在 `onBeforeUnmount` 中验证清理逻辑
- [ ] Chrome DevTools Memory Profiler 验证

**文件**: `src/components/AIEditing/index.vue`

**验收**: 多次进入退出页面后，内存不持续增长

---

### 🔴 P0: 超大组件拆分（3人天）
**问题**: `AIEditing/index.vue` 1,194行，`util.ts` 1,122行
**影响**: 维护困难、测试困难、协作冲突

**阶段1: index.vue 拆分** (2人天)
- [ ] 创建 `composables/useQuillEditor.ts`
- [ ] 创建 `composables/useAIPrompt.ts`
- [ ] 创建 `composables/useDiffEditor.ts`
- [ ] 提取 `QuillEditor.vue` 组件
- [ ] 提取 `AIPromptPanel.vue` 组件
- [ ] 提取 `AIResponsePanel.vue` 组件
- [ ] 提取 `DiffEditorPanel.vue` 组件

**验收**: `index.vue` 减少至 200行以下，所有功能正常

**阶段2: util.ts 拆分** (1人天)
- [ ] 创建 `utils/quillOperations.ts`
- [ ] 创建 `utils/diffEditor.ts`
- [ ] 创建 `utils/aiInteraction.ts`
- [ ] 创建 `utils/uiHelpers.ts`
- [ ] 更新所有导入路径

**验收**: 单文件不超过 250行

---

### 🔴 P1: ESLint 清理（0.5人天）
**问题**: 4 处 eslint-disable，9 处未使用变量

**任务**:
- [ ] 删除 `const table = null` (index.vue:40)
- [ ] 处理 `posCloseToBottom` (index.vue:46)
- [ ] 修复 monaco 导入方式 (monacoConfig.ts:6)
- [ ] 清理所有未使用的变量和导入

**验收**: ESLint 警告从 65 降至 20 以下

---

## 📋 近期规划（2-3周）

### 🟡 P1: TypeScript `any` 消除（1.5人天）
**问题**: 44 个 `any` 类型使用

**优先修复**:
- [ ] `api/api.ts` (3处)
- [ ] `services/useAI.ts` (3处)
- [ ] `components/AIEditing/api.ts` (2处)
- [ ] `components/AIEditing/export.ts` (7处)

**验收**: `any` 使用降至 15 以下（仅保留第三方库定义）

---

### 🟡 P1: TODO 注释实施（1人天）
**问题**: 3 处 TODO 注释未实施

**任务**:
- [ ] `storage.ts:23` - 实现或删除 `saveDraft`
- [ ] `storage.ts:51` - 实现或删除 `loadDraft`
- [ ] `logger.ts:113` - 集成 Sentry 监控

**验收**: 无未实施的 TODO 注释

---

### 🟡 P2: 测试覆盖率建设（3人天）
**问题**: 当前测试覆盖率 0%

**阶段1: 工具函数单元测试** (1人天)
- [ ] 配置 Vitest
- [ ] `utils/logger.test.ts`
- [ ] `utils/errorHandler.test.ts`
- [ ] `utils/darkMode.test.ts`

**阶段2: Store 单元测试** (1人天)
- [ ] `stores/chat.test.ts`
- [ ] `stores/app.test.ts`
- [ ] `stores/config.test.ts`

**阶段3: 组件集成测试** (1人天)
- [ ] `AIEditing.test.ts`
- [ ] `ChatMessages.test.ts`

**验收**: 核心业务逻辑覆盖率 60%+

---

## 📋 长期优化（4-5周）

### 🟢 P2: 性能优化实施（2人天）
**任务**:
- [ ] Monaco Editor 懒加载
- [ ] Quill 组件懒加载
- [ ] NaiveUI 按需导入
- [ ] 图片懒加载

**目标**:
- 首屏加载时间: ~2.5s → <1.5s (-40%)
- 包体积: ~3MB → <2MB (-33%)
- LCP: ~2.8s → <2.0s (-29%)

---

### 🟢 P3: 依赖包优化（0.5人天）
**任务**:
- [ ] 移除未使用的依赖 (fontawesome, add, html2pdf)
- [ ] `pnpm dedupe` 去重
- [ ] Bundle analyzer 分析

**目标**: node_modules 从 865MB 降至 730MB (-15%)

---

### 🟢 P3: 国际化完善（2人天）
**任务**:
- [ ] 完善 i18n 配置
- [ ] 提取所有硬编码文本
- [ ] 支持中英文切换

---

## 📊 关键指标跟踪

| 指标 | 基线 | 当前 | 目标 | 进度 |
|------|------|------|------|------|
| 项目健康度 | 60 | 72 | 85 | 🟡 84% |
| ESLint 警告 | 100+ | 65 | 20 | 🟡 35% |
| `any` 类型数 | 60+ | 44 | 15 | 🟡 66% |
| 测试覆盖率 | 0% | 0% | 60% | 🔴 0% |
| 首屏加载 | 2.5s | 2.5s | 1.5s | 🔴 0% |
| 最大组件行数 | 1,194 | 1,194 | 200 | 🔴 0% |

---

## ⚡ 本周行动计划（建议）

### Day 1-2: 内存泄漏修复
1. 安装 `@vueuse/core` (如未安装)
2. 替换所有 `addEventListener` 为 `useEventListener`
3. 验证清理逻辑
4. Chrome DevTools 验证

### Day 3-5: 超大组件拆分第一阶段
1. 创建 3 个核心 composables
2. 提取 QuillEditor 组件
3. 提取 AIPromptPanel 组件
4. 功能测试

### Day 6: ESLint 清理
1. 修复所有 eslint-disable
2. 清理未使用变量
3. 运行 `pnpm lint:fix`

---

## 🎯 验收检查表

**Week 1 完成标准**:
- [ ] Chrome DevTools Memory: 无内存泄漏
- [ ] ESLint 警告 ≤ 20
- [ ] `index.vue` 行数开始下降
- [ ] 所有功能正常运行

**Week 2 完成标准**:
- [ ] `AIEditing/index.vue` ≤ 200行
- [ ] `util.ts` 拆分完成
- [ ] 单元测试配置完成
- [ ] CI 通过

**Week 4 完成标准**:
- [ ] `any` 类型 ≤ 15
- [ ] 测试覆盖率 ≥ 60%
- [ ] 所有 TODO 已处理

---

## 📞 获取帮助

- **完整报告**: `claudedocs/重构优化报告-更新版.md`
- **项目文档**: `CLAUDE.md`
- **架构分析**: `claudedocs/` 目录

**最后更新**: 2025-10-01
