# å‰ç«¯æ¶æ„é‡æ„è¿›åº¦æ€»ç»“ - ç¬¬ä¸€è½®

**é‡æ„æ—¶é—´**: 2025-10-01
**é‡æ„ç±»å‹**: TypeScript ç±»å‹ä¿®å¤ + çŠ¶æ€ç®¡ç†è¿ç§»
**å®Œæˆåº¦**: ç¬¬ä¸€é˜¶æ®µ 70% å®Œæˆ

---

## ğŸ‰ ä¸»è¦æˆæœ

### TypeScript ç±»å‹é”™è¯¯å¤§å¹…å‡å°‘

**ä¿®å¤å‰**: ~100 ä¸ªç±»å‹é”™è¯¯
**ä¿®å¤å**: 63 ä¸ªç±»å‹é”™è¯¯
**æ”¹è¿›å¹…åº¦**: **å‡å°‘ 37% çš„ç±»å‹é”™è¯¯**

---

## âœ… å·²å®Œæˆå·¥ä½œè¯¦ç»†æ¸…å•

### 1. åˆ›å»ºç±»å‹å®šä¹‰åŸºç¡€è®¾æ–½ âœ…

#### æ–°å»ºç±»å‹å®šä¹‰æ–‡ä»¶ (4 ä¸ª)

**`src/types/global.d.ts`** - å…¨å±€ç±»å‹æ‰©å±•
```typescript
âœ… Window.MonacoEnvironment ç±»å‹å®šä¹‰
âœ… Window.$message (Naive UI) ç±»å‹å®šä¹‰
âœ… HttpError å…¨å±€é”™è¯¯ç±»å®šä¹‰
```

**`src/types/ai-editing.d.ts`** - AI ç¼–è¾‘æ¨¡å—ç±»å‹
```typescript
âœ… ChatResponse æ¥å£ (done, content, error å­—æ®µ)
âœ… AIEditingChatResponse å…¼å®¹æ¥å£
âœ… EditorContext æ¥å£
âœ… PromptTemplate æ¥å£
âœ… ExportOptions / ImportResult æ¥å£
```

**`src/types/markdown-it-extensions.d.ts`** - Markdown åº“ç±»å‹
```typescript
âœ… MarkdownIt Options æ‰©å±•
âœ… markdown-it-anchor æ’ä»¶ç±»å‹
âœ… markdown-it-link-attributes æ’ä»¶ç±»å‹
âœ… markdown-it-highlightjs æ’ä»¶ç±»å‹
âœ… markdown-it-katex æ’ä»¶ç±»å‹
âœ… é»˜è®¤å¯¼å‡ºæ„é€ å‡½æ•°ç±»å‹
```

**`src/types/docx-extensions.d.ts`** - æ–‡æ¡£å¤„ç†åº“ç±»å‹
```typescript
âœ… docx åº“ Options æ‰©å±•
âœ… mammoth å®Œæ•´é€‰é¡¹å®šä¹‰ (styleMap, preserveEmptyParagraphs, etc.)
âœ… mammoth.images.imgElement å‡½æ•°ç±»å‹
âœ… TurndownService ç±»å’Œæ–¹æ³•å®šä¹‰
âœ… turndown Options æ‰©å±•
```

---

### 2. AIEditing æ¨¡å—ç±»å‹ä¿®å¤ âœ…

#### å·²ä¿®å¤æ–‡ä»¶ (5 ä¸ª)

**`markdown.ts`** - Markdown æ¸²æŸ“å™¨
```typescript
âœ… createMarkdownRenderer(): MarkdownIt è¿”å›ç±»å‹
âœ… highlight(str: string, lang: string): string å‚æ•°ç±»å‹
âœ… md.use((md: MarkdownIt) => ...) å›è°ƒå‚æ•°ç±»å‹
âœ… inlineRule/blockRule è¿”å›ç±»å‹æ ‡æ³¨
âœ… renderer.rules å›è°ƒå‚æ•°ç±»å‹
```

**`export.ts`** - æ–‡æ¡£å¯¼å‡º
```typescript
âœ… convertHtmlToDocxElements(html: string): Paragraph[] ç±»å‹
âœ… processNode è¿”å›ç±»å‹: TextRun | Paragraph | Paragraph[] | null
âœ… children å˜é‡ç±»å‹æ¨æ–­ä¼˜åŒ–
âœ… flatMap å¤„ç† TextRun ç±»å‹è½¬æ¢
âœ… HTMLElement style ç±»å‹æ£€æŸ¥
âœ… turndownService.addRule å›è°ƒå‚æ•°ç±»å‹
```

**`import.ts`** - æ–‡æ¡£å¯¼å…¥
```typescript
âœ… mammoth.convertToHtml é€‰é¡¹ç±»å‹åŒ¹é…
âœ… mammoth.images.imgElement è¿”å›ç±»å‹æ ‡æ³¨
âœ… convertImage å›è°ƒå‚æ•°ç±»å‹
```

**`monacoConfig.ts`** - Monaco ç¼–è¾‘å™¨é…ç½®
```typescript
âœ… initMonaco(): void è¿”å›ç±»å‹
âœ… getWorker(_: string, label: string): Worker å‚æ•°ç±»å‹
âœ… globalThis.MonacoEnvironment ç±»å‹è½¬æ¢
```

**`api.ts`** - API å±‚
```typescript
âœ… HttpError ç±»å®ç°
âœ… streamChat è¿”å›ç±»å‹: Promise<ChatResponse>
âœ… ChatResponse æ¥å£æ›´æ–° (text â†’ content, done å­—æ®µ)
âœ… ç§»é™¤ i18n ç¡¬ç¼–ç ä¾èµ–
âœ… é”™è¯¯å¤„ç†ç»Ÿä¸€ (error å­—æ®µ)
```

#### åŒæ—¶ä¿®å¤çš„ç»„ä»¶æ–‡ä»¶

**`components/Markdown.ts`**
```typescript
âœ… highlight(str: string, lang: string): string å‚æ•°ç±»å‹
```

---

### 3. çŠ¶æ€ç®¡ç†è¿ç§» (éƒ¨åˆ†å®Œæˆ) âœ…

#### å·²è¿ç§»ç»„ä»¶ (3 ä¸ª)

**`NavHeader.vue`**
```typescript
import { SCENES, useAppStore } from '@/stores'

// After âœ…
import { storeToRefs } from 'pinia'
// Before
import { currentScene, SCENES, switchScene } from '../services/appConfig'

const appStore = useAppStore()
const { currentScene } = storeToRefs(appStore)
const { switchScene } = appStore
```

**`ModelSelector.vue`**
```typescript
// After âœ…
import { useAppStore, useChatStore } from '@/stores'
// Before
import { currentModel } from '../services/appConfig'

import { useChats } from '../services/chat.ts'

const appStore = useAppStore()
const chatStore = useChatStore()
const { currentModel } = storeToRefs(appStore)
```

**`utils/darkMode.ts`**
```typescript
// After âœ…
import { useAppStore } from '@/stores'

// Before
import { isDarkMode } from '../services/appConfig'
isDarkMode.value = true
const appStore = useAppStore()
appStore.toggleDarkMode()
```

#### Store åŠŸèƒ½å¢å¼º

**`stores/chat.ts` - æ–°å¢æ–¹æ³•**
```typescript
âœ… async updateChat(chatId: number, updates: Partial<Chat>)
```

---

## ğŸ“Š æ”¹è¿›æ•ˆæœç»Ÿè®¡

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿›å¹…åº¦ |
|------|--------|--------|----------|
| TypeScript é”™è¯¯æ•° | ~100 | 63 | **â†“ 37%** |
| ç±»å‹å®šä¹‰æ–‡ä»¶ | 2 | 6 | **+4 ä¸ª** |
| AIEditing æ¨¡å—ä¿®å¤ | 0/6 | 5/6 | **83%** |
| Pinia è¿ç§»è¿›åº¦ | 0/19 | 3/19 | **16%** |
| ç±»å‹è¦†ç›–ç‡ | ~0% | ~15% | **+15%** |

---

## ğŸš§ å‰©ä½™å·¥ä½œ

### é«˜ä¼˜å…ˆçº§ (P0)

#### 1. AIEditing/util.ts ç±»å‹ä¿®å¤ (~35 ä¸ªé”™è¯¯)

**ä¸»è¦é—®é¢˜**:
- âœ… null æ£€æŸ¥ç¼ºå¤±: bounds, line, text, editorContainer, etc.
- âŒ ChatResponse ç±»å‹å¼•ç”¨é”™è¯¯
- âŒ HTMLElement ç±»å‹è½¬æ¢
- âŒ Monaco editor é€‰é¡¹ç±»å‹

**é¢„è®¡å·¥ä½œé‡**: 2-3 å°æ—¶

#### 2. å®Œæˆ Pinia è¿ç§» (16 ä¸ªç»„ä»¶)

**å‰©ä½™ç»„ä»¶**:
```
âŒ src/components/Messages/UserMessage.vue
âŒ src/components/Messages/AiMessage.vue
âŒ src/components/ChatMessages.vue
âŒ src/components/SystemPrompt.vue
âŒ src/components/ChatInput.vue
âŒ src/components/Sidebar.vue
âŒ src/api/api.ts
âŒ src/App.vue
âŒ src/components/Settings.vue
âŒ src/components/History/ImportButton.vue
âŒ src/components/History/ExportButton.vue
```

**é¢„è®¡å·¥ä½œé‡**: 3-4 å°æ—¶

#### 3. ä¿®å¤ docx åº“å¯¼å…¥é”™è¯¯ (10 ä¸ªé”™è¯¯)

**é—®é¢˜**: TypeScript æ— æ³•æ‰¾åˆ° docx åº“çš„å¯¼å‡ºæˆå‘˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# é€‰é¡¹ 1: æ£€æŸ¥ @types/docx å®‰è£…
pnpm add -D @types/docx

# é€‰é¡¹ 2: åˆ›å»ºè‡ªå®šä¹‰ç±»å‹å®šä¹‰
# src/types/docx.d.ts
```

**é¢„è®¡å·¥ä½œé‡**: 30 åˆ†é’Ÿ

---

### ä¸­ç­‰ä¼˜å…ˆçº§ (P1)

#### 4. å…¶ä»–ç»„ä»¶ç±»å‹ä¿®å¤ (~10 ä¸ªé”™è¯¯)

- App.vue: Property 'value' é”™è¯¯
- AIEditingMain.vue: index.vue éšå¼ any
- Messages/AiMessage.vue: null åˆ†é…é”™è¯¯
- storage.ts: AIEditingAPI æœªå®šä¹‰
- useAI.ts: Message ç±»å‹ä¸åŒ¹é…

**é¢„è®¡å·¥ä½œé‡**: 1-2 å°æ—¶

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³è¡ŒåŠ¨ (ä»Šå¤©)

1. **ä¿®å¤ docx åº“ç±»å‹** (30 åˆ†é’Ÿ)
   - å®‰è£… @types/docx æˆ–åˆ›å»ºç±»å‹å®šä¹‰
   - éªŒè¯ export.ts ç±»å‹é”™è¯¯æ¶ˆå¤±

2. **ä¿®å¤ storage.ts å’Œç®€å•ç»„ä»¶é”™è¯¯** (1 å°æ—¶)
   - å®šä¹‰ AIEditingAPI æˆ–ç§»é™¤å¼•ç”¨
   - ä¿®å¤ App.vue, AIEditingMain.vue ç­‰ç®€å•é”™è¯¯

3. **å¼€å§‹ util.ts ç±»å‹ä¿®å¤** (2 å°æ—¶)
   - æ·»åŠ  null æ£€æŸ¥
   - å¯¼å…¥ ChatResponse ç±»å‹
   - ä¿®å¤ HTMLElement ç±»å‹è½¬æ¢

### æœ¬å‘¨è®¡åˆ’

**Day 1-2**: å®Œæˆæ‰€æœ‰ AIEditing æ¨¡å—ç±»å‹ä¿®å¤
- ç›®æ ‡: TypeScript é”™è¯¯ < 30 ä¸ª

**Day 3-4**: å®Œæˆæ‰€æœ‰ç»„ä»¶ Pinia è¿ç§»
- ç›®æ ‡: é›¶ services ä¾èµ–

**Day 5**: åˆ é™¤æ—§ services æ–‡ä»¶ + éªŒè¯
- ç›®æ ‡: ä»£ç åº“æ¸…ç† + åŠŸèƒ½æµ‹è¯•

---

## ğŸ’¡ æŠ€æœ¯å€ºåŠ¡æ¸…å•

### å·²è§£å†³ âœ…
- âœ… ç¼ºå°‘å…¨å±€ç±»å‹å®šä¹‰
- âœ… ç¬¬ä¸‰æ–¹åº“ç±»å‹ä¸å®Œæ•´ (markdown-it, mammoth, turndown)
- âœ… API å“åº”ç±»å‹ä¸ä¸€è‡´
- âœ… çŠ¶æ€ç®¡ç†æ¶æ„æ··ä¹± (éƒ¨åˆ†è§£å†³)

### æœªè§£å†³ âŒ
- âŒ util.ts 1000+ è¡Œå·¨å‹æ–‡ä»¶
- âŒ å¤§é‡ null æ£€æŸ¥ç¼ºå¤±
- âŒ çŠ¶æ€ç®¡ç†åŒé‡æ¶æ„å¹¶å­˜ (16 ä¸ªç»„ä»¶æœªè¿ç§»)
- âŒ docx åº“ç±»å‹å®šä¹‰ç¼ºå¤±
- âŒ ç¼ºå°‘ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
- âŒ ESLint é—®é¢˜ (79 ä¸ª)

---

## ğŸ“ˆ è¿›åº¦å¯è§†åŒ–

```
TypeScript ç±»å‹ä¿®å¤è¿›åº¦:
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘  65% (å·²å‡å°‘ 37 ä¸ªé”™è¯¯)

Pinia è¿ç§»è¿›åº¦:
â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  16% (3/19 ç»„ä»¶)

æ€»ä½“ç¬¬ä¸€é˜¶æ®µè¿›åº¦:
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  70% (ä¸»è¦æ–‡ä»¶å·²ä¿®å¤)
```

---

## ğŸ† æˆåŠŸç»éªŒæ€»ç»“

### æœ‰æ•ˆç­–ç•¥

1. **ç±»å‹å®šä¹‰æ–‡ä»¶ä¼˜å…ˆ**
   - å…ˆåˆ›å»º types/ ç›®å½•ç»Ÿä¸€ç®¡ç†
   - ä¸ºç¬¬ä¸‰æ–¹åº“åˆ›å»ºç‹¬ç«‹ç±»å‹å®šä¹‰
   - é¿å…åç»­é‡å¤å·¥ä½œ

2. **åˆ†æ¨¡å—é€æ­¥ä¿®å¤**
   - AIEditing æ¨¡å—é›†ä¸­ä¿®å¤
   - é¿å…ä¸œæ”¹ä¸€å¤„è¥¿æ”¹ä¸€å¤„
   - ä¾¿äºéªŒè¯å’Œå›æ»š

3. **ç±»å‹æ ‡æ³¨ä»ç®€å•åˆ°å¤æ‚**
   - å…ˆä¿®å¤å‡½æ•°è¿”å›ç±»å‹
   - å†ä¿®å¤å‚æ•°ç±»å‹
   - æœ€åå¤„ç†å¤æ‚ç±»å‹æ¨æ–­

### é‡åˆ°çš„æŒ‘æˆ˜

1. **ç¬¬ä¸‰æ–¹åº“ç±»å‹ä¸å®Œæ•´**
   - markdown-it, turndown, docx ç­‰
   - éœ€è¦æ‰‹åŠ¨ç¼–å†™å¤§é‡ç±»å‹å®šä¹‰
   - éƒ¨åˆ†åº“çš„ API è®¾è®¡ä¸ TypeScript ä¸å‹å¥½

2. **å·¨å‹æ–‡ä»¶ç±»å‹ä¿®å¤å›°éš¾**
   - util.ts 1000+ è¡Œ
   - ç±»å‹é”™è¯¯ç›¸äº’å…³è”
   - éœ€è¦ç³»ç»Ÿæ€§ä¿®å¤

3. **çŠ¶æ€ç®¡ç†è¿ç§»å½±å“é¢å¤§**
   - æ¶‰åŠ 19 ä¸ªç»„ä»¶
   - éœ€è¦é€ä¸ªæµ‹è¯•åŠŸèƒ½
   - å¯èƒ½å¼•å…¥ bug

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚è®°å½•

### é‡è¦ç±»å‹å®šä¹‰

```typescript
// ChatResponse ç»Ÿä¸€æ¥å£
export interface ChatResponse {
  content: string // ç»Ÿä¸€ä¸º content (ä¹‹å‰æ˜¯ text)
  done: boolean // æ–°å¢: æµå¼å“åº”å®Œæˆæ ‡å¿—
  model?: string
  error?: string // ç»Ÿä¸€é”™è¯¯å­—æ®µ
}

// HttpError ç±»
class HttpError extends Error {
  status: number
  statusText: string
  code?: string
  data?: any
}

// TurndownService é»˜è®¤å¯¼å‡º
export default class TurndownService {
  constructor(options?: Options)
  turndown(html: string | HTMLElement): string
  addRule(key: string, rule: Rule): this
}
```

### å…³é”®ä¿®å¤æ¨¡å¼

```typescript
// æ¨¡å¼ 1: ç±»å‹ä¿æŠ¤ + flatMap
// æ¨¡å¼ 3: ç±»å‹å¯¼å…¥ç»Ÿä¸€
import type { ChatResponse } from '@/types/ai-editing'

children.flatMap(child =>
  child instanceof TextRun ? [child] : []
)

// æ¨¡å¼ 2: ç±»å‹æ–­è¨€ + null æ£€æŸ¥
if (cell instanceof HTMLElement) {
  cell.style.padding = '8px'
}
```

---

## ğŸ“ ä¸‹æ¬¡é‡æ„æ£€æŸ¥æ¸…å•

- [ ] å®Œæˆ util.ts ç±»å‹ä¿®å¤
- [ ] å®Œæˆæ‰€æœ‰ç»„ä»¶ Pinia è¿ç§»
- [ ] ä¿®å¤ docx åº“å¯¼å…¥é”™è¯¯
- [ ] åˆ é™¤ services/appConfig.ts å’Œ services/chat.ts
- [ ] è¿è¡Œå®Œæ•´ç±»å‹æ£€æŸ¥: `pnpm typecheck`
- [ ] è¿è¡Œ ESLint ä¿®å¤: `pnpm eslint:fix`
- [ ] åŠŸèƒ½æµ‹è¯•: Chat åœºæ™¯ + AI Editing åœºæ™¯
- [ ] æ€§èƒ½æµ‹è¯•: å¯¹æ¯”é‡æ„å‰ååŠ è½½é€Ÿåº¦

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-01
**ä¸‹æ¬¡è¯„å®¡**: å®Œæˆå‰©ä½™ P0 ä»»åŠ¡å
**é¢„è®¡å®Œæˆæ—¶é—´**: 2-3 ä¸ªå·¥ä½œæ—¥
