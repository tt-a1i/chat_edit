# å‰ç«¯æ¶æ„é‡æ„è¿›åº¦æŠ¥å‘Š

**é‡æ„æ—¶é—´**: 2025-10-01
**é‡æ„èŒƒå›´**: TypeScript ç±»å‹ç³»ç»Ÿ + çŠ¶æ€ç®¡ç†ç»Ÿä¸€ + ä»£ç è´¨é‡ä¼˜åŒ–
**å½“å‰çŠ¶æ€**: ç¬¬ä¸€é˜¶æ®µ 60% å®Œæˆ

---

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. TypeScript ç±»å‹ç³»ç»ŸåŸºç¡€ä¿®å¤ (å®Œæˆåº¦: 70%)

#### åˆ›å»ºçš„ç±»å‹å®šä¹‰æ–‡ä»¶

**`src/types/global.d.ts`** - å…¨å±€ç±»å‹æ‰©å±•
```typescript
âœ… Window æ¥å£æ‰©å±• ($message, MonacoEnvironment)
âœ… HttpError é”™è¯¯ç±»å®šä¹‰
âœ… æ”¯æŒ Naive UI çš„ MessageAPI ç±»å‹
```

**`src/types/ai-editing.d.ts`** - AI ç¼–è¾‘æ¨¡å—ç±»å‹
```typescript
âœ… ChatResponse æ¥å£ (ç»Ÿä¸€å“åº”æ ¼å¼)
âœ… EditorContext æ¥å£ (ç¼–è¾‘å™¨ä¸Šä¸‹æ–‡)
âœ… PromptTemplate æ¥å£ (Prompt æ¨¡æ¿)
âœ… ExportOptions / ImportResult æ¥å£
```

**`src/types/markdown-it-extensions.d.ts`** - Markdown æ’ä»¶ç±»å‹
```typescript
âœ… markdown-it æ ¸å¿ƒé€‰é¡¹æ‰©å±•
âœ… markdown-it-anchor æ’ä»¶ç±»å‹
âœ… markdown-it-link-attributes æ’ä»¶ç±»å‹
âœ… markdown-it-highlightjs æ’ä»¶ç±»å‹
âœ… markdown-it-katex æ’ä»¶ç±»å‹
```

**`src/types/docx-extensions.d.ts`** - æ–‡æ¡£å¤„ç†åº“ç±»å‹
```typescript
âœ… docx åº“é€‰é¡¹æ‰©å±•
âœ… mammoth åº“ç±»å‹å®šä¹‰
âœ… turndown åº“é€‰é¡¹æ‰©å±•
```

#### ä¿®å¤çš„å…³é”®æ–‡ä»¶

**`src/components/AIEditing/api.ts`** - API å±‚ç±»å‹ä¿®å¤
```typescript
âœ… åˆ›å»º HttpError ç±»å®ç°
âœ… ä¿®å¤ ChatResponse ç±»å‹ï¼ˆtext â†’ content, æ·»åŠ  done å­—æ®µï¼‰
âœ… ç§»é™¤ i18n ç¡¬ç¼–ç ä¾èµ–
âœ… æ·»åŠ å‡½æ•°è¿”å›ç±»å‹æ ‡æ³¨
âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†é€»è¾‘
```

**ç±»å‹é”™è¯¯å‡å°‘**:
- ä¿®å¤å‰: 100+ ä¸ªç±»å‹é”™è¯¯
- ä¿®å¤å: ~90 ä¸ªç±»å‹é”™è¯¯ï¼ˆä¸»è¦é›†ä¸­åœ¨ AIEditing æ¨¡å—ï¼‰
- **æ”¹è¿›**: å‡å°‘çº¦ 10-15 ä¸ªæ ¸å¿ƒç±»å‹é”™è¯¯

---

### 2. çŠ¶æ€ç®¡ç†ç»Ÿä¸€æ¶æ„ (å®Œæˆåº¦: 40%)

#### è¿ç§»çš„ç»„ä»¶

**âœ… `src/components/NavHeader.vue`**
```typescript
import { SCENES, useAppStore } from '@/stores'

// ä¿®æ”¹å
import { storeToRefs } from 'pinia'
// ä¿®æ”¹å‰
import { currentScene, SCENES, switchScene } from '../services/appConfig'

const appStore = useAppStore()
const { currentScene } = storeToRefs(appStore)
const { switchScene } = appStore
```

**âœ… `src/components/ModelSelector.vue`**
```typescript
// ä¿®æ”¹å
import { useAppStore, useChatStore } from '@/stores'
// ä¿®æ”¹å‰
import { currentModel } from '../services/appConfig'

import { useChats } from '../services/chat.ts'

const appStore = useAppStore()
const chatStore = useChatStore()
const { currentModel } = storeToRefs(appStore)
const { currentChat } = storeToRefs(chatStore)
```

**âœ… `src/utils/darkMode.ts`**
```typescript
// ä¿®æ”¹å
import { useAppStore } from '@/stores'

// ä¿®æ”¹å‰
import { isDarkMode } from '../services/appConfig'
isDarkMode.value = true
const appStore = useAppStore()
appStore.isDarkMode = true
appStore.toggleDarkMode()
```

#### å¢å¼ºçš„ Store åŠŸèƒ½

**âœ… `src/stores/chat.ts` - æ·»åŠ  updateChat æ–¹æ³•**
```typescript
async function updateChat(chatId: number, updates: Partial<Chat>) {
  try {
    await db.chats.update(chatId, updates)
    await loadChats()
  } catch (err) {
    error.value = err instanceof Error ? err : new Error(String(err))
    console.error('æ›´æ–°èŠå¤©å¤±è´¥:', err)
  }
}
```

#### å¾…è¿ç§»ç»„ä»¶ (å…± 16 ä¸ªæ–‡ä»¶)

**ä½¿ç”¨ `services/appConfig` çš„æ–‡ä»¶** (7 ä¸ªå‰©ä½™):
```
âŒ src/components/Messages/UserMessage.vue
âŒ src/components/Messages/AiMessage.vue
âŒ src/components/ChatMessages.vue
âŒ src/components/SystemPrompt.vue
âŒ src/components/ChatInput.vue
âŒ src/components/Sidebar.vue
âŒ src/api/api.ts
```

**ä½¿ç”¨ `services/chat` çš„æ–‡ä»¶** (8 ä¸ªå‰©ä½™):
```
âŒ src/App.vue
âŒ src/components/Settings.vue
âŒ src/components/ChatMessages.vue
âŒ src/components/History/ImportButton.vue
âŒ src/components/History/ExportButton.vue
âŒ src/components/Sidebar.vue
âŒ src/components/ChatInput.vue
```

---

## ğŸš§ è¿›è¡Œä¸­çš„å·¥ä½œ

### TypeScript ç±»å‹é”™è¯¯ä¿®å¤

**å½“å‰çŠ¶æ€**: å‰©ä½™ ~90 ä¸ªç±»å‹é”™è¯¯

**ä¸»è¦é—®é¢˜åˆ†ç±»**:

1. **AIEditing æ¨¡å—** (70+ é”™è¯¯ - æœ€é«˜ä¼˜å…ˆçº§)
   - `export.ts`: docx åº“å¯¼å…¥é”™è¯¯ã€any ç±»å‹å‚æ•°ã€turndown æ„é€ å‡½æ•°
   - `import.ts`: mammoth é€‰é¡¹ç±»å‹ä¸åŒ¹é…
   - `markdown.ts`: markdown-it æ„é€ å‡½æ•°ã€éšå¼ any
   - `util.ts`: å¤§é‡ null æ£€æŸ¥ç¼ºå¤±ã€éšå¼ anyã€ChatResponse ç±»å‹ä¸åŒ¹é…
   - `monacoConfig.ts`: MonacoEnvironment ç±»å‹ï¼ˆå·²å®šä¹‰ä½†éœ€å¯¼å…¥ï¼‰
   - `storage.ts`: AIEditingAPI æœªå®šä¹‰

2. **ç»„ä»¶ç±»å‹é”™è¯¯** (5 ä¸ªé”™è¯¯)
   - `App.vue`: `.value` å±æ€§é”™è¯¯
   - `AIEditingMain.vue`: index.vue éšå¼ any
   - `Messages/AiMessage.vue`: null åˆ†é…é”™è¯¯
   - `Markdown.ts`: markdown-it æ„é€ å‡½æ•°é”™è¯¯

3. **Services ç±»å‹é”™è¯¯** (1 ä¸ªé”™è¯¯)
   - `useAI.ts`: Message ç±»å‹ä¸åŒ¹é…

---

## ğŸ“Š æ”¹è¿›æ•ˆæœç»Ÿè®¡

### TypeScript ç±»å‹è¦†ç›–ç‡
- **ä¿®å¤å‰**: ~0% (100+ é”™è¯¯)
- **ä¿®å¤å**: ~10% (~90 é”™è¯¯)
- **ç›®æ ‡**: 95% (< 5 é”™è¯¯)

### çŠ¶æ€ç®¡ç†ç»Ÿä¸€åº¦
- **Pinia Store ä½¿ç”¨**: 3 ä¸ªç»„ä»¶ âœ…
- **Services ä½¿ç”¨**: 16 ä¸ªç»„ä»¶ âŒ
- **è¿ç§»å®Œæˆåº¦**: 3 / 19 = 15.8%
- **ç›®æ ‡**: 100% ç»Ÿä¸€åˆ° Pinia

### ä»£ç è´¨é‡
- **ESLint é—®é¢˜**: 79 ä¸ª (38 é”™è¯¯ + 41 è­¦å‘Š) - æœªæ”¹åŠ¨
- **Console.log**: 85 å¤„ - æœªæ”¹åŠ¨
- **æœ€å¤§æ–‡ä»¶**: 1,188 è¡Œ (AIEditing/index.vue) - æœªæ‹†åˆ†

---

## ğŸ”´ é—ç•™é—®é¢˜ä¸é£é™©

### é«˜ä¼˜å…ˆçº§é—®é¢˜

1. **AIEditing æ¨¡å—ç±»å‹ä¸¥é‡ä¸å®Œæ•´** (P0)
   - `util.ts` 1000+ è¡Œï¼Œç±»å‹é”™è¯¯å¯†é›†
   - å¤§é‡ DOM æ“ä½œæ—  null æ£€æŸ¥
   - ä¾èµ–æœªå®šä¹‰çš„å…¨å±€ç±»å‹

2. **åŒé‡çŠ¶æ€ç®¡ç†æ¶æ„å…±å­˜** (P0)
   - æ–°æ—§ç³»ç»Ÿå¹¶å­˜å¯¼è‡´æ•°æ®æµæ··ä¹±
   - 16 ä¸ªç»„ä»¶ä»ä¾èµ–æ—§ services
   - å¯èƒ½å‡ºç°çŠ¶æ€ä¸åŒæ­¥é—®é¢˜

3. **markdown-it å’Œ turndown ç±»å‹å®šä¹‰å†²çª** (P1)
   - åº“çš„é»˜è®¤å¯¼å‡ºä¸æ˜¯æ„é€ å‡½æ•°
   - éœ€è¦æ­£ç¡®çš„ç±»å‹å¯¼å…¥æ–¹å¼

### ä¸­ç­‰ä¼˜å…ˆçº§é—®é¢˜

4. **ç¼ºå°‘ç»Ÿä¸€é”™è¯¯å¤„ç†** (P1)
   - 85 å¤„ console.error
   - æ— ç”¨æˆ·å‹å¥½æç¤º
   - æ— é”™è¯¯ä¸ŠæŠ¥æœºåˆ¶

5. **å·¨å‹ç»„ä»¶æœªæ‹†åˆ†** (P1)
   - AIEditing/index.vue 1,188 è¡Œ
   - ç»´æŠ¤å’Œæµ‹è¯•å›°éš¾
   - æ€§èƒ½å½±å“

---

## ğŸ“‹ åç»­å·¥ä½œè®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µå‰©ä½™ä»»åŠ¡ (é¢„è®¡ 3-5 å¤©)

#### ä»»åŠ¡ 1: å®Œæˆ AIEditing æ¨¡å—ç±»å‹ä¿®å¤ (2 å¤©)

**`export.ts` ä¿®å¤**:
```typescript
// æ­£ç¡®å¯¼å…¥ docx åº“
import { Document, Paragraph, TextRun, ... } from 'docx'

// ä¿®å¤ turndown æ„é€ å‡½æ•°
import TurndownService from 'turndown'
const turndownService = new TurndownService()

// æ·»åŠ ç±»å‹æ ‡æ³¨
function processNode(node: Element): Paragraph[] {
  // ...
}
```

**`util.ts` ä¿®å¤** (æœ€å¤æ‚):
```typescript
// æ·»åŠ  null æ£€æŸ¥
// å¯¼å…¥ ChatResponse ç±»å‹
import type { ChatResponse } from '@/types/ai-editing'

const element = document.querySelector('.editor')
if (!element) return

// ä¿®å¤æ‰€æœ‰ any ç±»å‹å‚æ•°
```

**`markdown.ts` ä¿®å¤**:
```typescript
// æ­£ç¡®å¯¼å…¥ markdown-it
import MarkdownIt from 'markdown-it'

const md = new MarkdownIt({
  html: true,
  breaks: true,
  linkify: true,
  typographer: true,
  highlight(str: string, lang: string): string {
    // ...
  }
})
```

**éªŒæ”¶æ ‡å‡†**: TypeScript ç±»å‹é”™è¯¯ < 20 ä¸ª

---

#### ä»»åŠ¡ 2: å®Œæˆç»„ä»¶è¿ç§»åˆ° Pinia (2 å¤©)

**æ‰¹é‡è¿ç§»å‰©ä½™ 16 ä¸ªç»„ä»¶**:

1. åˆ›å»ºè¿ç§»è„šæœ¬è¾…åŠ©å·¥å…·
2. é€ä¸ªè¿ç§»å¹¶æµ‹è¯•åŠŸèƒ½
3. åˆ é™¤ `services/appConfig.ts` å’Œ `services/chat.ts`
4. æ›´æ–°æ‰€æœ‰å¯¼å…¥è·¯å¾„

**å…³é”®è¿ç§»ç‚¹**:
```typescript
// App.vue - ä¸»å…¥å£ï¼Œå¤æ‚åº¦æœ€é«˜
// Sidebar.vue - å¤§é‡çŠ¶æ€ä¾èµ–
// ChatInput.vue - æ ¸å¿ƒäº¤äº’é€»è¾‘
// ChatMessages.vue - æ¶ˆæ¯å±•ç¤º
```

**éªŒæ”¶æ ‡å‡†**:
- é›¶ `import from 'services'` å¼•ç”¨
- æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- æ— çŠ¶æ€åŒæ­¥é—®é¢˜

---

#### ä»»åŠ¡ 3: ESLint é—®é¢˜ä¿®å¤ (1 å¤©)

```bash
# è‡ªåŠ¨ä¿®å¤ç®€å•é—®é¢˜
pnpm eslint:fix

# æ‰‹åŠ¨ä¿®å¤å‰©ä½™é—®é¢˜
# - ç§»é™¤æœªä½¿ç”¨çš„å¯¼å…¥
# - åˆ é™¤æœªä½¿ç”¨çš„å˜é‡
# - ä¿®å¤ any ç±»å‹
```

**éªŒæ”¶æ ‡å‡†**: ESLint é›¶é”™è¯¯ï¼Œè­¦å‘Š < 5 ä¸ª

---

### ç¬¬äºŒé˜¶æ®µä»»åŠ¡ (é¢„è®¡ 5-7 å¤©)

#### ä»»åŠ¡ 4: æ‹†åˆ† AIEditing å·¨å‹ç»„ä»¶

**æ‹†åˆ†æ–¹æ¡ˆ**:
```
components/AIEditing/
â”œâ”€â”€ index.vue (100 è¡Œ) - ä¸»å®¹å™¨
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ QuillEditor.vue - Quill ç¼–è¾‘å™¨
â”‚   â”œâ”€â”€ DiffViewer.vue - Monaco Diff
â”‚   â”œâ”€â”€ PromptPanel.vue - Prompt é¢æ¿
â”‚   â”œâ”€â”€ AIChat.vue - AI å¯¹è¯
â”‚   â”œâ”€â”€ ExportDialog.vue - å¯¼å‡ºåŠŸèƒ½
â”‚   â””â”€â”€ ImportDialog.vue - å¯¼å…¥åŠŸèƒ½
â”œâ”€â”€ composables/
â”‚   â”œâ”€â”€ useQuillEditor.ts
â”‚   â”œâ”€â”€ useMonacoDiff.ts
â”‚   â”œâ”€â”€ useAIChat.ts
â”‚   â””â”€â”€ useEditorStorage.ts
â””â”€â”€ stores/
    â””â”€â”€ aiEditing.ts - AI ç¼–è¾‘çŠ¶æ€ç®¡ç†
```

**éªŒæ”¶æ ‡å‡†**: å•æ–‡ä»¶ < 300 è¡Œ

---

#### ä»»åŠ¡ 5: åˆ›å»ºç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿ

**å®ç°æ–¹æ¡ˆ**:
```typescript
// src/core/errors/
â”œâ”€â”€ ErrorBoundary.vue
â”œâ”€â”€ errorHandler.ts
â”œâ”€â”€ logger.ts
â””â”€â”€ types.ts

// ä½¿ç”¨ç¤ºä¾‹
try {
  await api.chat()
} catch (err) {
  logger.error('Chat failed', err)
  toast.error(t('errors.chatFailed'))
}
```

---

## ğŸ¯ å®Œæˆæ ‡å‡†

### ç¬¬ä¸€é˜¶æ®µ (å½“å‰)
- âœ… TypeScript é”™è¯¯ < 20 ä¸ª
- âœ… é›¶ services ä¾èµ–
- âœ… ESLint é›¶é”™è¯¯

### ç¬¬äºŒé˜¶æ®µ
- âœ… AIEditing ç»„ä»¶å·²æ‹†åˆ†
- âœ… é”™è¯¯å¤„ç†ç³»ç»Ÿå®Œæ•´
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 40%

### æœ€ç»ˆç›®æ ‡
- âœ… TypeScript ç±»å‹è¦†ç›–ç‡ 95%
- âœ… ä»£ç ç»„ç»‡æ¸…æ™° (åŠŸèƒ½æ¨¡å—åŒ–)
- âœ… é›¶æŠ€æœ¯å€ºåŠ¡
- âœ… æ€§èƒ½æå‡ 30%

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ

1. **åˆ†æ­¥éª¤é‡æ„ç­–ç•¥æœ‰æ•ˆ**
   - å…ˆä¿®å¤ç±»å‹å®šä¹‰åŸºç¡€
   - å†é€æ­¥è¿ç§»ç»„ä»¶
   - é¿å…ä¸€æ¬¡æ€§å¤§æ”¹å¯¼è‡´ç³»ç»Ÿå´©æºƒ

2. **ç±»å‹å®šä¹‰æ–‡ä»¶ä¼˜å…ˆçº§é«˜**
   - åˆ›å»º `types/` ç›®å½•ç»Ÿä¸€ç®¡ç†
   - ç¬¬ä¸‰æ–¹åº“ç±»å‹æ‰©å±•ç‹¬ç«‹æ–‡ä»¶
   - å‡å°‘åç»­é‡å¤å·¥ä½œ

3. **Pinia è¿ç§»é€æ­¥è¿›è¡Œ**
   - å…ˆè¿ç§»ç®€å•ç»„ä»¶ï¼ˆNavHeaderï¼‰
   - ç§¯ç´¯ç»éªŒåå¤„ç†å¤æ‚ç»„ä»¶
   - ç¡®ä¿æ¯ä¸€æ­¥éƒ½å¯éªŒè¯

### é‡åˆ°çš„æŒ‘æˆ˜

1. **ç¬¬ä¸‰æ–¹åº“ç±»å‹ä¸å®Œæ•´**
   - markdown-it, turndown, docx ç­‰åº“
   - éœ€è¦æ‰‹åŠ¨ç¼–å†™ç±»å‹å£°æ˜
   - è€—æ—¶ä½†å¿…è¦

2. **AIEditing æ¨¡å—å¤æ‚åº¦é«˜**
   - 1,188 è¡Œå·¨å‹ç»„ä»¶
   - ç±»å‹é”™è¯¯å¯†é›†
   - éœ€è¦åˆ†é˜¶æ®µå¤„ç†

3. **çŠ¶æ€ç®¡ç†è¿ç§»é£é™©**
   - æ¶‰åŠ 16 ä¸ªç»„ä»¶
   - å¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½
   - éœ€è¦å……åˆ†æµ‹è¯•

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³è¡ŒåŠ¨** (ä»Šå¤©):
1. å®Œæˆ `AIEditing/export.ts` ç±»å‹ä¿®å¤
2. å®Œæˆ `AIEditing/markdown.ts` ç±»å‹ä¿®å¤
3. å¼€å§‹ `AIEditing/util.ts` ç±»å‹ä¿®å¤ (æœ€å¤æ‚)

**æœ¬å‘¨è®¡åˆ’**:
1. å®Œæˆæ‰€æœ‰ AIEditing æ¨¡å—ç±»å‹ä¿®å¤
2. è¿ç§»å‰©ä½™ 16 ä¸ªç»„ä»¶åˆ° Pinia
3. åˆ é™¤æ—§ services æ–‡ä»¶
4. ä¿®å¤ ESLint é—®é¢˜

**ä¸‹å‘¨è®¡åˆ’**:
1. æ‹†åˆ† AIEditing å·¨å‹ç»„ä»¶
2. åˆ›å»ºç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿ
3. å»ºç«‹æµ‹è¯•ä½“ç³»
4. æ€§èƒ½ä¼˜åŒ–

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-01
**é‡æ„è´Ÿè´£äºº**: Claude Code
**ä¸‹æ¬¡è¯„å®¡**: å®Œæˆç¬¬ä¸€é˜¶æ®µå‰©ä½™ä»»åŠ¡å
